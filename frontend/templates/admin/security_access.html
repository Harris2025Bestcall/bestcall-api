{% extends "admin/base_system_ops.html" %}

{% block title %}Security & Access - BestCall AI{% endblock %}

{% block content %}
  <h1>User Access & Security</h1>

  <p>This page allows you to view, manage, and modify user roles and credentials.</p>

  <div id="userTable"></div>

  <script>
    async function loadUsers() {
      const token = localStorage.getItem("access_token");
      const res = await fetch("/users", {
        headers: {
          "Authorization": "Bearer " + token
        }
      });

      const users = await res.json();
      const container = document.getElementById("userTable");
      container.innerHTML = "";

      const table = document.createElement("table");
      table.border = "1";
      table.cellPadding = "6";

      const header = document.createElement("tr");
      ["Name", "Email", "Role", "Actions"].forEach(text => {
        const th = document.createElement("th");
        th.innerText = text;
        header.appendChild(th);
      });
      table.appendChild(header);

      users.forEach(user => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>
            <select onchange="updateRole('${user.email}', this.value)">
              <option value="dealer" ${user.role === "dealer" ? "selected" : ""}>Dealer</option>
              <option value="admin" ${user.role === "admin" ? "selected" : ""}>Admin</option>
            </select>
          </td>
          <td>
            <button onclick="resetPassword('${user.email}')">Reset Password</button>
          </td>
        `;
        table.appendChild(tr);
      });

      container.appendChild(table);
    }

    async function updateRole(email, newRole) {
      const token = localStorage.getItem("access_token");
      await fetch("/update_role", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ email, role: newRole })
      });
      alert(`Role updated to ${newRole}`);
    }

    async function resetPassword(email) {
      const token = localStorage.getItem("access_token");
      const newPass = prompt(`Enter a new password for ${email}`);
      if (!newPass) return;

      await fetch("/reset_password", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ email, password: newPass })
      });
      alert("Password reset successfully.");
    }

    loadUsers();
  </script>
{% endblock %}
